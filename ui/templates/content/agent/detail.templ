package agent

import (
	"fmt"

	v1 "github.com/soltiHQ/control-plane/api/v1"
	"github.com/soltiHQ/control-plane/internal/ui/policy"
	"github.com/soltiHQ/control-plane/internal/ui/routepath"
	"github.com/soltiHQ/control-plane/ui/templates/asset"
	"github.com/soltiHQ/control-plane/ui/templates/component/card"
	"github.com/soltiHQ/control-plane/ui/templates/component/datagrid"
	"github.com/soltiHQ/control-plane/ui/templates/component/modal"
	"github.com/soltiHQ/control-plane/ui/templates/component/visual"
)

templ Detail(a v1.Agent, p policy.AgentDetail) {
	@Identity(a, p)
}

templ Identity(a v1.Agent, p policy.AgentDetail) {
	@card.Card("") {
		@card.CardBody() {
			<div class="space-y-6">
				<div class="space-y-2">
					@visual.Badge("Online", visual.VariantSuccess)
				</div>

				<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-1 gap-6">
					<div class="space-y-3 min-w-0">
						<dl class="space-y-3">
							@datagrid.KV("Agent ID", a.ID, true)
							@datagrid.KV("Name", a.Name, false)
							@datagrid.KV("Endpoint", a.Endpoint, false)
							@datagrid.KV("Platform", a.Platform, false)
							@datagrid.KV("OS", a.OS, false)
							@datagrid.KV("Arch", a.Arch, false)
							if a.UptimeSeconds > 0 {
								@datagrid.KV("Uptime", formatUptime(a.UptimeSeconds), false)
							}
						</dl>
					</div>

					<div class="space-y-3 min-w-0">
						<dl class="space-y-3">
							@labelBadges("Labels", a.Labels)
							@metadataBadges("Metadata", a.Metadata)
						</dl>
					</div>
				</div>
			</div>
		}

		@card.CardFooter() {
			if p.CanEditLabels {
				<button
					type="button"
					class="inline-flex items-center justify-center gap-2 h-10 px-4 rounded-2xl bg-card text-fg border border-border shadow-sm hover:border-primary/40 hover:shadow-md active:shadow-sm transition-all duration-200 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary/40"
					x-data
					x-on:click={ modal.OpenEvent("edit-agent") }
				>
					@asset.Icon("edit")
				</button>
			}
		}
	}

	if p.CanEditLabels {
		@modal.Edit(
			"edit-agent",
			"Edit labels",
			routepath.ApiAgentLabels(a.ID),
			editLabelFields(a),
			nil,
		)
	}
}

templ labelBadges(label string, m map[string]string) {
	<div class="min-w-0">
		<dt class="text-[11px] font-mono uppercase tracking-[0.1em] text-muted mb-0.5">{ label }</dt>

		if len(m) == 0 {
			<dd class="text-sm text-fg/60 break-words leading-snug">—</dd>
		} else {
			<dd class="flex flex-wrap gap-1.5">
				for k, v := range m {
					@visual.Badge(fmt.Sprintf("%s=%s", k, v), visual.VariantSecondary)
				}
			</dd>
		}
	</div>
}

templ metadataBadges(label string, m map[string]string) {
	<div class="min-w-0">
		<dt class="text-[11px] font-mono uppercase tracking-[0.1em] text-muted mb-0.5">{ label }</dt>

		if len(m) == 0 {
			<dd class="text-sm text-fg/60 break-words leading-snug">—</dd>
		} else {
			<dd class="flex flex-wrap gap-1.5">
				for k, v := range m {
					@visual.Badge(fmt.Sprintf("%s=%s", k, v), visual.VariantPrimary)
				}
			</dd>
		}
	</div>
}
