package agent

import (
	"fmt"
	"net/url"

	"github.com/soltiHQ/control-plane/domain/model"
	"github.com/soltiHQ/control-plane/internal/ui/routepath"
	"github.com/soltiHQ/control-plane/ui/templates/component/datagrid"
	"github.com/soltiHQ/control-plane/ui/templates/component/search"
)

templ List(items []*model.Agent, nextCursor string, q string) {
	<div class="space-y-4">
		<div class="flex justify-center mb-10">
			<div class="w-[320px] max-sm:w-full">
				@search.Input(
					"agents-search",
					"q",
					q,
					"Searchâ€¦",
					routepath.ApiAgents,
					"#agents-results",
				)
			</div>
		</div>

		@Results(items, nextCursor, q)
	</div>
}

templ Results(items []*model.Agent, nextCursor string, q string) {
	<div id="agents-results" class="space-y-4">
		<div id="agents-cards" class="grid gap-3 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3">
			@Cards(items)
		</div>

		<div id="agents-footer">
			@Footer(nextCursor, q)
		</div>
	</div>
}

templ Cards(items []*model.Agent) {
	if len(items) == 0 {
		@datagrid.Empty("No agents found")
	} else {
		for _, a := range items {
			<a
				href={ templ.SafeURL(routepath.PageAgentInfoByID(a.ID())) }
				class="
					group relative
					rounded-[var(--r-6)] border border-border bg-card
					p-4
					block cursor-pointer [&_*]:cursor-pointer
					transition-all duration-200
					hover:border-primary/40
					hover:shadow-[var(--shadow)]
				"
			>
				<!-- status + name + uptime -->
				<div class="flex items-center gap-2.5 mb-3">
					<span class="relative flex h-2 w-2 shrink-0">
						<span class="absolute inline-flex h-full w-full animate-ping rounded-full bg-success/60"></span>
						<span class="relative inline-flex h-2 w-2 rounded-full bg-success"></span>
					</span>

					<span class="text-sm font-semibold text-fg truncate">
						if a.Name() != "" {
							{ a.Name() }
						} else {
							{ a.ID() }
						}
					</span>

					if a.UptimeSeconds() > 0 {
						<span class="ml-auto text-[10px] font-mono text-muted tabular-nums shrink-0">
							{ formatUptime(a.UptimeSeconds()) }
						</span>
					}
				</div>

				<!-- id -->
				if a.Name() != "" {
					<div class="text-[11px] font-mono text-muted tracking-wide truncate mb-3">
						{ a.ID() }
					</div>
				}

				<!-- endpoint -->
				if a.Endpoint() != "" {
					<div class="text-xs text-muted-strong truncate mb-3">
						{ a.Endpoint() }
					</div>
				}

				<!-- platform pills -->
				<div class="flex items-center gap-1.5 flex-wrap">
					if a.Platform() != "" {
						<span class="inline-flex items-center rounded-full bg-primary/8 px-2 py-0.5 text-[10px] font-medium text-primary/80">
							{ a.Platform() }
						</span>
					}
					if a.OS() != "" {
						<span class="inline-flex items-center rounded-full bg-fg/5 px-2 py-0.5 text-[10px] font-medium text-muted-strong">
							{ a.OS() }
						</span>
					}
					if a.Arch() != "" {
						<span class="inline-flex items-center rounded-full bg-fg/5 px-2 py-0.5 text-[10px] font-medium text-muted-strong">
							{ a.Arch() }
						</span>
					}
				</div>
			</a>
		}
	}
}

templ Footer(nextCursor string, q string) {
	if nextCursor != "" {
		<div
			id="agents-sentinel"
			class="h-6"
			hx-get={ agentsListURL(nextCursor, q) }
			hx-trigger="revealed"
			hx-target="#agents-cards"
			hx-swap="beforeend"
			hx-sync="#agents-sentinel:replace"
		></div>
	}
}

func agentsListURL(nextCursor string, q string) string {
	v := url.Values{}
	if nextCursor != "" {
		v.Set("cursor", nextCursor)
	}
	if q != "" {
		v.Set("q", q)
	}
	qs := v.Encode()
	if qs == "" {
		return routepath.ApiAgents
	}
	return routepath.ApiAgents + "?" + qs
}

func formatUptime(s int64) string {
	switch {
	case s < 60:
		return fmt.Sprintf("%ds", s)
	case s < 3600:
		return fmt.Sprintf("%dm", s/60)
	case s < 86400:
		return fmt.Sprintf("%dh %dm", s/3600, (s%3600)/60)
	default:
		return fmt.Sprintf("%dd %dh", s/86400, (s%86400)/3600)
	}
}
